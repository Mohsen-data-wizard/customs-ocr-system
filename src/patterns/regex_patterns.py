#!/usr/bin/env python3
# -*- coding: utf-8 -*-

"""
الگوهای Regex برای استخراج فیلدها
"""

from typing import Dict, List

class PatternManager:
    """مدیر الگوهای استخراج"""
    
    def __init__(self):
        self.import_patterns = self._get_import_patterns()
        self.export_patterns = self._get_export_patterns()
    
    def _get_import_patterns(self) -> Dict[str, List[str]]:
        """الگوهای وارداتی بهبود یافته"""
        return {
            "شماره_کوتاژ": [
                r'(\d{8})(?=\s*[-–]\s*زمینی)',
                r'(\d{8})(?=\s*08019)',
                r'(\d{8})(?=\s*\d{4}[-/]\d{1,2}[-/]\d{1,2})',
                r'(?:کوتاژ|اظهارنامه).*?(\d{8})',
                r'(\d{8})\s*\d{5}[-–]\d{4}',
                r'شماره.*?ثبت.*?(\d{8})',
                r'برگه.*?شماره.*?(\d{8})',
            ],
            
            "کشور_طرف_معامله": [
                r'\b(CN|TR|AE|IQ|DE|RU|KW|NL|US|GB|FR|IT)\b',
                r'(CN|TR|AE|IQ|DE|RU|KW|NL)(?=\s*مبدا|\s*کشور|\s*$)',
                r'(?:مبدا|کشور|صادرکننده).*?(CN|TR|AE|IQ|DE|RU|KW|NL)',
                r'کشور\s*طرف\s*معامله.*?(CN|TR|AE|IQ|DE|RU|KW|NL)',
                r'(\w{2})(?=\s*کشور\s*طرف)',
                r'17\s+.*?(CN|TR|AE|IQ|DE|RU|KW|NL)',
            ],
            
            "نوع_معامله": [
                r'(برات|بدون\s*انتقال\s*ارز|حواله\s*ارزی|پیله\s*وری)',
                r'نوع\s*معامله.*?(برات|بدون\s*انتقال\s*ارز|حواله\s*ارزی|پیله\s*وری)',
                r'24\s+.*?(برات|بدون\s*انتقال\s*ارز|حواله\s*ارزی|پیله\s*وری)',
                r'(CPT|CIF|FOB|EXW)',
                r'تحویل.*?(CPT|CIF|FOB|EXW)',
            ],
            
            "نوع_بسته": [
                r'(عدد|پالت|نگله|سایر|رول|کارتن|گونی|جعبه)(?=\s*\d+\.0)',
                r'31\s+.*?(عدد|پالت|نگله|سایر|رول|کارتن|گونی|جعبه)',
                r'بسته.*?(عدد|پالت|نگله|سایر|رول|کارتن|گونی|جعبه)',
                r'نوع\s*بسته.*?(عدد|پالت|نگله|سایر|رول|کارتن|گونی|جعبه)',
                r'(عدد|پالت|نگله|سایر|رول|کارتن|گونی|جعبه)(?=.*031)',
            ],
            
            "نرخ_ارز": [
                r'نرخ\s*ارز.*?(\d{6,8})',
                r'23\s+.*?(\d{6,8})',
                r'(\d{6,8})(?=\s*(?:EUR|USD|یورو|دلار))',
                r'نرخ.*?(\d{6,8})',
                r'023.*?(\d{6,8})',
                r'(\d{6,8})(?=.*(?:تبدیل|معادل))',
            ],
            
            "نوع_ارز": [
                r'\b(EUR|USD|CNY|AED|GBP|TRY)\b',
                r'\((EUR|USD|CNY|AED|GBP|TRY)\)',
                r'(یورو|دلار|درهم|لیر|یوان|پوند)',
                r'ارز.*?(EUR|USD|CNY|AED|GBP|TRY)',
                r'مبلغ.*?(EUR|USD|CNY|AED|GBP|TRY)',
            ],
            
            "کد_کالا": [
                r'(8[5-9]\d{6})',
                r'کد\s*کالا.*?(\d{8})',
                r'33\s+.*?(\d{8})',
                r'(\d{8})(?=\s*(?:NL|CN|TR|DE)\s*سازنده)',
                r'HS.*?(\d{8})',
                r'(\d{8})(?=\s*کد\s*کالا)',
            ],
            
            "وزن_خالص": [
                r'وزن\s*خالص.*?(\d{3,7})\.?0?',
                r'38\s+.*?(\d{3,7})',
                r'(\d{3,7})\.?0?\s*(?:کیلوگرم|کیلو|kg)',
                r'خالص.*?(\d{3,7})\.?0?',
                r'(\d{3,7})(?=\.0\s*(?:کیلو|خالص))',
                r'035.*?(\d{3,7})',
            ],
            
            "مبلغ_کل_فاکتور": [
                r'مبلغ\s*کل\s*فاکتور.*?(\d{5,12})\.?0?0?',
                r'22\s+.*?(\d{5,12})',
                r'فاکتور.*?(\d{5,12})\.?0?0?',
                r'(\d{5,12})\.0?0?\s*(?:EUR|USD|یورو|دلار)',
                r'کل.*?(\d{5,12})\.?0?0?',
                r'total.*?(\d{5,12})',
            ],
            
            "ارزش_گمرکی_قلم_کالا": [
                r'ارزش\s*گمرکی.*?(\d{8,15})',
                r'46\s+.*?(\d{8,15})',
                r'گمرکی.*?(\d{8,15})',
                r'قلم\s*کالا.*?(\d{8,15})',
                r'(\d{8,15})(?=.*گمرکی)',
                r'CIF.*?(\d{8,15})',
            ],
            
            "بیمه": [
                r'بیمه\s*:?\s*(\d{1,12})\.?0?0?',
                r'47\s+.*?(\d{1,12})',
                r'بیمه.*?(\d{1,12})\.?0?0?',
                r'(\d{1,12})\.0?0?(?=.*بیمه)',
                r'Insurance.*?(\d{1,12})',
            ],
            
            "کرایه": [
                r'کرایه\s*:?\s*(\d{1,10})\.?0?0?',
                r'35\s+.*?(\d{1,10})',
                r'کرایه.*?(\d{1,10})\.?0?0?',
                r'(\d{1,10})\.0?0?(?=.*کرایه)',
                r'Freight.*?(\d{1,10})',
            ],
            
            "تعداد_واحد_کالا": [
                r'تعداد\s*واحد.*?(\d{1,4})\.?0?',
                r'41\s+.*?(\d{1,4})',
                r'واحد.*?(\d{1,4})\.?0?',
                r'(\d{1,4})\.0(?=.*واحد)',
                r'(\d{1,4})\s*عدد(?=.*واحد)',
            ],
            
            "تعداد_بسته": [
                r'تعداد\s*بسته.*?(\d{1,4})\.?0?',
                r'31\s+.*?(\d{1,4})',
                r'بسته.*?(\d{1,4})\.?0?',
                r'(\d{1,4})\.0(?=.*بسته)',
                r'(\d{1,4})\s*(?:عدد|پالت|نگله)',
            ],
            
            "شرح_کالا": [
                r'شرح\s*کالا\s*:?\s*([^:\n]{10,100}?)(?=\s*[:؛\n])',
                r'شرح\s*تجاری.*?:?\s*([^:\n]{10,80})',
                r'(کامیون\s*کشنده|تراکتور|کشنده|خودرو|ماشین\s*آلات|قطعات)',
                r'31\s+([^31\n]{15,60})(?=\s*\d)',
                r'([^:\n]{20,80}?)(?=\s*(?:سازنده|تولید|مدل))',
                r'Description\s*:?\s*([^:\n]{10,80})',
            ],
            
            "کد_ثبت_سفارش": [
                r'کد\s*ثبت\s*سفارش.*?(\d{8})',
                r'ثبت\s*سفارش.*?(\d{8})',
                r'سفارش.*?(\d{8})',
                r'(\d{8})(?=.*سفارش)',
                r'Order.*?(\d{8})',
            ],
            
            "مبلغ_حقوق_ورودی": [
                r'حقوق\s*ورودی.*?(\d{6,13})',
                r'(\d{6,13})(?=.*حقوق\s*ورودی)',
                r'مبلغ\s*حقوق\s*ورودی.*?(\d{6,13})',
                r'جمع\s*حقوق.*?(\d{6,13})',
                r'041.*?(\d{6,13})',
            ],
            
            "مبلغ_مالیات_بر_ارزش_افزوده": [
                r'مالیات.*?ارزش\s*افزوده.*?(\d{6,13})',
                r'(\d{6,13})(?=.*مالیات.*ارزش\s*افزوده)',
                r'VAT.*?(\d{6,13})',
                r'مبلغ\s*مالیات\s*بر\s*ارزش\s*افزوده.*?(\d{6,13})',
                r'042.*?(\d{6,13})',
            ],
            
            "جمع_حقوق_و_عوارض_قلم": [
                r'جمع\s*حق\s*و\s*حقوق\s*عوارض.*?(\d{6,13})',
                r'(\d{6,13})(?=.*جمع.*عوارض)',
                r'جمع\s*عوارض.*?(\d{6,13})',
                r'مبلغ\s*عوارض.*?(\d{6,13})',
                r'043.*?(\d{6,13})',
            ]
        }
    
    def _get_export_patterns(self) -> Dict[str, List[str]]:
        """الگوهای صادراتی"""
        import_patterns = self._get_import_patterns()
        
        # انتخاب فیلدهای مناسب برای صادرات
        export_fields = [
            "شماره_کوتاژ", "شرح_کالا", "کد_کالا", "تعداد_بسته", "نوع_بسته",
            "نوع_ارز", "مبلغ_کل_فاکتور", "نرخ_ارز", "وزن_خالص", "تعداد_واحد_کالا",
            "نوع_معامله", "ارزش_گمرکی_قلم_کالا", "کشور_طرف_معامله"
        ]
        
        return {field: patterns for field, patterns in import_patterns.items() 
                if field in export_fields}
    
    def get_patterns(self, document_type: str) -> Dict[str, List[str]]:
        """دریافت الگوهای مناسب بر اساس نوع سند"""
        if document_type == "وارداتی":
            return self.import_patterns
        elif document_type == "صادراتی":
            return self.export_patterns
        else:
            return self.import_patterns
    
    def add_custom_pattern(self, field_name: str, pattern: str, document_type: str = "وارداتی"):
        """اضافه کردن الگوی سفارشی"""
        target_patterns = self.import_patterns if document_type == "وارداتی" else self.export_patterns
        
        if field_name in target_patterns:
            target_patterns[field_name].append(pattern)
        else:
            target_patterns[field_name] = [pattern]
